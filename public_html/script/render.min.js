var tileD=32,screenW=29*tileD,screenH=31*tileD,screenRatio=screenW/screenH,arenaX1=2*tileD,arenaY1=5*tileD,arenaD=screenW-(2*tileD+2*tileD),arenaRate=arenaD/25,nglad=0,json,loadglads=!1,startsim=!1,loadCache=!1,stab,gender,simtimenow,actionlist=[{name:"fireball",value:0,animation:"cast"},{name:"teleport",value:1,animation:"cast"},{name:"charge",value:2,animation:"walk"},{name:"block",value:3,animation:"cast"},{name:"assassinate",value:4,animation:"shoot"},{name:"ambush",value:5,animation:"cast"},
{name:"melee",value:6,animation:"melee"},{name:"ranged",value:7,animation:"shoot"},{name:"movement",value:8,animation:"walk"},{name:"waiting",value:9,animation:"none"},{name:"none",value:10,animation:"none"}],animationlist={walk:{start:8,frames:9},cast:{start:0,frames:7},shoot:{start:16,frames:10},stab:{start:4,frames:8},slash:{start:12,frames:6},die:{start:20,frames:6}};function phaser_update(c){json=c;0==nglad&&loadCache&&(nglad=json.glads.length)}var game;
function load_phaser(){game&&game.destroy();game=new Phaser.Game($(document).width(),$(document).height(),Phaser.AUTO,"canvas-div",{preload:preload,create:create,update:update,render:render})}
function preload(){for(i=0;i<hashes.length;i++)game.cache.addSpriteSheet("glad"+i,null,hashes[i],192,192);game.load.image("background","res/map3.png");game.load.image("background_top","res/map3_top.png");game.load.image("background_walls","res/map3_walls.png");game.load.image("arrow","res/arrow.png");game.load.image("mask","res/mask.png");game.load.spritesheet("fireball","res/fireball.png",64,64);game.load.spritesheet("explosion","res/explosion.png",256,128);game.load.spritesheet("stun","res/stun.png",
96,64);game.load.spritesheet("level","res/level.png",192,192);game.load.spritesheet("shield","res/shield.png",192,192);game.load.audio("music","res/audio/adventure.mp3");game.load.audio("ending","res/audio/ending.mp3");game.load.audio("victory","res/audio/victory.mp3");game.load.audio("fireball","res/audio/fireball.mp3");game.load.audio("explosion","res/audio/explosion.mp3");game.load.audio("teleport","res/audio/teleport.mp3");game.load.audio("charge_male","res/audio/charge_male.mp3");game.load.audio("charge_female",
"res/audio/charge_female.mp3");game.load.audio("block","res/audio/block.mp3");game.load.audio("assassinate","res/audio/assassinate.mp3");game.load.audio("ambush","res/audio/ambush.mp3");game.load.audio("ranged","res/audio/ranged.mp3");game.load.audio("arrow_hit","res/audio/arrow_hit.mp3");game.load.audio("stun","res/audio/stun.mp3");game.load.audio("melee","res/audio/melee.mp3");game.load.audio("lvlup","res/audio/lvlup.mp3");game.load.audio("death_male","res/audio/death_male.mp3");game.load.audio("death_female",
"res/audio/death_female.mp3");game.load.start();loadCache=!0;resize();$("#canvas-div canvas").focus();game.camera.focusOnXY(screenW*game.camera.scale.x/2,screenH*game.camera.scale.y/2)}var background,back_top,back_walls,layer_walls,layer_ground,layer_poison,sprite=[],sproj=[],gladArray=[],projArray=[],music,ending,victory,clones=[],poison=Math.sqrt(2*Math.pow(arenaD/2,2))/arenaRate,mask,groupglad,bar={};
function create(){game.physics.startSystem(Phaser.Physics.ARCADE);background=game.add.image(0,0,"background");back_top=game.add.image(0,0,"background_top");back_walls=game.add.image(0,0,"background_walls");mask=game.add.image(arenaX1+arenaD/2+tileD/2,arenaY1+arenaD/2+tileD/2,"mask");mask.anchor.setTo(.5,.5);mask.scale.set(arenaRate);mask.alpha=.3;groupglad=game.add.group();groupglad.add(background);groupglad.add(back_top);groupglad.add(back_walls);groupglad.add(mask);music=game.add.audio("music",
1,!0);ending=game.add.audio("ending");victory=game.add.audio("victory");game.input.mouse.onMouseWheel=zoomWheel;game.input.onDown.add(function(c){c.button===Phaser.Mouse.LEFT_BUTTON&&(game.input.mouse.drag=!0)},this);game.input.mouse.drag=!1;game.input.onUp.add(function(c){game.input.mouse.drag=!1},this);var c=game.add.graphics(0,0);c.beginFill(0);c.drawRect(-100,0,30,9);var e=game.add.graphics(0,0);e.beginFill(16711680);e.drawRect(-100,0,30,5);var d=game.add.graphics(0,0);d.beginFill(255);d.drawRect(-100,
0,30,4);bar.back=game.add.sprite(-100,0,c.generateTexture());bar.back.alpha=.15;bar.hp=game.add.sprite(-100,0,e.generateTexture());bar.hp.alpha=.4;bar.ap=game.add.sprite(-100,0,d.generateTexture());bar.ap.alpha=.4}
function update(){json.poison&&(poison=parseFloat(json.poison),mask.scale.setTo(poison*arenaRate/Math.sqrt(2*Math.pow(arenaD/2,2))*arenaRate*.42));if(0<nglad&&!loadglads){loadglads=!0;for(b=0;b<nglad;b++)sprite[b]=game.add.sprite(arenaX1+parseFloat(json.glads[b].x)*arenaRate,arenaY1+parseFloat(json.glads[b].y)*arenaRate,"glad"+newindex[b]),sprite[b].anchor.setTo(.5,.5),createAnimation(b,"walk"),createAnimation(b,"melee"),createAnimation(b,"slash"),createAnimation(b,"stab"),createAnimation(b,"shoot"),
createAnimation(b,"cast"),sprite[b].animations.add("die",arrayFill(260,265),10,!1),groupglad.add(sprite[b]),gladArray[b]={x:0,y:0,hp:parseFloat(json.glads[b].hp),alive:!0,fade:0,clone:null,invisible:!1,stun:!1,assassinate:!1,level:1,block:!1,charge:!1,poison:!1,xp:parseInt(json.glads[b].xp),time:!1},gladArray[b].bars=game.add.bitmapData(arenaX1+25*arenaRate,arenaY1+25*arenaRate),gladArray[b].bars.addToWorld();music.play();music.volume=.1}else if(0<sprite.length){startsim||(startsim=!0,$("#fog").remove(),
$("#canvas-container").css({opacity:1}),resize(),pausesim=!1);if(json&&simtimenow!=json.simtime)for(simtimenow=json.simtime,b=0;b<nglad;b++){var c=parseFloat(json.glads[b].x),e=parseFloat(json.glads[b].y),d=parseInt(json.glads[b].action),f=parseInt(json.glads[b].lvl),g=parseInt(json.glads[b].xp),m=parseFloat(json.glads[b].head),h=parseFloat(json.glads[b].hp),l=parseFloat(json.glads[b].lockedfor);showMessageBaloon(b);sprite[b].x=arenaX1+c*arenaRate;sprite[b].y=arenaY1+e*arenaRate;showHpApBars(b);f>
gladArray[b].level&&(gladArray[b].level=f,f=game.add.sprite(sprite[b].x,sprite[b].y,"level"),f.anchor.setTo(.5),f.scale.setTo(.4),groupglad.add(f),f.animations.add("levelup",null,15,!1),f.animations.play("levelup",null,!1,!0),game.add.audio("lvlup").play());h!=gladArray[b].hp&&("fireball"==actionlist[d].name&&.1<json.glads[b].buffs.burn.timeleft&&(f=game.add.sprite(sprite[b].x,sprite[b].y,"explosion"),f.anchor.setTo(.5,.5),f.alpha=.5,f.width=5*arenaRate,f.height=3*arenaRate,f.animations.add("explode",
null,15,!0),f.animations.play("explode",null,!1,!0),game.add.audio("explosion").play()),gladArray[b].hp=h);0>=h?(gladArray[b].alive&&(sprite[b].animations.play("die"),"male"==gender[newindex[b]]?game.add.audio("death_male").play():game.add.audio("death_female").play()),gladArray[b].alive=!1):(gladArray[b].alive=!0,h=actionlist[d].animation+"-"+getActionDirection(m),"movement"==actionlist[d].name?sprite[b].animations.play(h):"charge"==actionlist[d].name?gladArray[b].charge||(sprite[b].animations.stop(),
sprite[b].animations.play(h,50,!0),gladArray[b].charge=!0,"male"==gender[newindex[b]]?game.add.audio("charge_male").play():game.add.audio("charge_female").play()):actionlist[d]&&"none"!=actionlist[d].animation&&gladArray[b].time!=json.simtime&&(sprite[b].animations.play(h,Math.max(1/((l-.1)/animationlist[actionlist[d].animation].frames*2),10)),gladArray[b].time=json.simtime,"teleport"==actionlist[d].name&&0==gladArray[b].fade&&(gladArray[b].fade=1,gladArray[b].x=sprite[b].x,gladArray[b].y=sprite[b].y,
game.add.audio("teleport").play()),"assassinate"==actionlist[d].name&&(gladArray[b].assassinate=!0),"block"==actionlist[d].name&&(gladArray[b].block=!1),"ranged"==actionlist[d].name&&game.add.audio("ranged").play(),"melee"==actionlist[d].name&&game.add.audio("melee").play()));gladArray[b].invisible=.1<json.glads[b].buffs.invisible.timeleft?!0:!1;gladArray[b].invisible?(1<=sprite[b].alpha&&game.add.audio("ambush").play(),.3<sprite[b].alpha&&(sprite[b].alpha-=.05)):1>sprite[b].alpha&&(sprite[b].alpha+=
.05);1!=gladArray[b].fade||gladArray[b].x==sprite[b].x&&gladArray[b].y==sprite[b].y?2==gladArray[b].fade&&(sprite[b].alpha+=.05,1<=sprite[b].alpha&&(sprite[b].alpha=1,gladArray[b].fade=0)):(clones.push(game.add.sprite(gladArray[b].x,gladArray[b].y,sprite[b].key,sprite[b].frame)),clones[clones.length-1].anchor.setTo(.5,.5),clones[clones.length-1].alpha=1,sprite[b].alpha=0,gladArray[b].fade=2);for(k in clones)clones[k].alpha-=.05,0>=clones[k].alpha&&(clones[k].destroy(),clones.splice(k,1));!gladArray[b].stun&&
.1<json.glads[b].buffs.stun.timeleft&&gladArray[b].alive?(gladArray[b].stun=game.add.sprite(sprite[b].x,sprite[b].y,"stun"),gladArray[b].stun.anchor.setTo(.5,1),gladArray[b].stun.scale.setTo(.6),groupglad.add(gladArray[b].stun),gladArray[b].stun.animations.add("stun",null,15,!0),gladArray[b].stun.animations.play("stun",null,!0,!1),game.add.audio("stun").play()):gladArray[b].stun&&(.1>=json.glads[b].buffs.stun.timeleft||!gladArray[b].alive)&&(gladArray[b].stun.destroy(),gladArray[b].stun=!1);!gladArray[b].block&&
.1<json.glads[b].buffs.resist.timeleft?(gladArray[b].block=!0,l=game.add.sprite(sprite[b].x,sprite[b].y,"shield"),l.anchor.setTo(.5),l.scale.setTo(.4),groupglad.add(l),l.animations.add("shield",null,15,!1),l.animations.play("shield",null,!1,!0),l.alpha=.5,game.add.audio("block").play()):gladArray[b].block&&.1>=json.glads[b].buffs.resist.timeleft&&(gladArray[b].block=!1);gladArray[b].charge&&(g!=gladArray[b].xp?(sprite[b].animations.currentAnim.speed=15,h="0"==stab[newindex[b]]?"slash-"+getActionDirection(m):
"stab-"+getActionDirection(m),sprite[b].animations.play(h,20),game.add.audio("melee").play()):"charge"!=actionlist[d].name&&(sprite[b].animations.currentAnim.speed=15,gladArray[b].charge=!1));gladArray[b].poison=Math.sqrt(Math.pow(12.5-c,2)+Math.pow(12.5-e,2))>=poison?!0:!1;sprite[b].tint=json.glads[b].buffs.burn&&.1<json.glads[b].buffs.burn.timeleft?16756850:gladArray[b].poison?9895318:gladArray[b].block?16770355:16777215;gladArray[b].xp=g;$("#time").slider("value")!=10*parseFloat(json.simtime)&&
$("#time").slider("value",10*parseFloat(json.simtime));update_ui(json)}debugTimer()}var b;if(json.projectiles&&0<json.projectiles.length)for(e=json.projectiles.length,b=0;b<e;b++){d=json.projectiles[b].id;g=json.projectiles[b].type;var k=findProj(d);if(-1==k){if(0==json.projectiles[b].type)var n=game.add.sprite(0,0,"arrow");else 1==json.projectiles[b].type?(n=game.add.sprite(0,0,"fireball"),n.animations.add("fireball",arrayFill(0,7),15,!0),n.animations.play("fireball"),game.add.audio("fireball").play()):
2==json.projectiles[b].type&&(n=game.add.sprite(0,0,"arrow"),n.tint=65280);gladArray[json.projectiles[b].owner]&&gladArray[json.projectiles[b].owner].assassinate&&(gladArray[json.projectiles[b].owner].assassinate=!1,n=game.add.sprite(0,0,"arrow"),n.tint=16711680,game.add.audio("assassinate").play());n.anchor.setTo(.5,.5);k=sproj.length;sproj.push({sprite:n,active:!0,id:d,type:g})}sproj[k].sprite.x=arenaX1+parseFloat(json.projectiles[b].x)*arenaRate;sproj[k].sprite.y=arenaY1+parseFloat(json.projectiles[b].y)*
arenaRate;sproj[k].sprite.angle=parseFloat(json.projectiles[b].head)+90;sproj[k].active=!0}for(c in sproj)!1===sproj[c].active?(1==sproj[c].type?(f=game.add.sprite(sproj[c].sprite.x,sproj[c].sprite.y,"explosion"),f.anchor.setTo(.5,.5),f.alpha=.5,f.width=5*arenaRate,f.height=3*arenaRate,f.animations.add("explode",null,15,!0),f.animations.play("explode",null,!1,!0),game.add.audio("explosion").play()):game.add.audio("arrow_hit").play(),sproj[c].sprite.destroy(),sproj.splice(c,1)):sproj[c].active=!1;
groupglad.sort("y",Phaser.Group.SORT_ASCENDING);for(b=0;b<nglad;b++)gladArray[b].alive||groupglad.sendToBack(sprite[b]);groupglad.sendToBack(mask);groupglad.sendToBack(background);groupglad.bringToTop(back_top);game.input.mouse.drag&&(game.camera.target&&($(".ui-glad").removeClass("follow"),game.camera.unfollow()),game.camera.view.y-=game.input.speed.y,game.camera.view.x-=game.input.speed.x);(game.input.keyboard.isDown(Phaser.Keyboard.NUMPAD_ADD)||game.input.keyboard.isDown(Phaser.Keyboard.EQUALS))&&
zoomWheel({deltaY:-1});(game.input.keyboard.isDown(Phaser.Keyboard.NUMPAD_SUBTRACT)||game.input.keyboard.isDown(Phaser.Keyboard.UNDERSCORE))&&zoomWheel({deltaY:1});game.input.keyboard.isDown(Phaser.Keyboard.LEFT)&&(game.camera.view.x-=10);game.input.keyboard.isDown(Phaser.Keyboard.RIGHT)&&(game.camera.view.x+=10);game.input.keyboard.isDown(Phaser.Keyboard.UP)&&(game.camera.view.y-=10);game.input.keyboard.isDown(Phaser.Keyboard.DOWN)&&(game.camera.view.y+=10)}function render(){}
function findProj(c){for(i in sproj)if(sproj[i].id==c)return i;return-1}function arrayFill(c,e){for(a=[];c<=e;c++)a.push(c);return a}function getActionDirection(c){return 45<=c&&135>=c?"right":135<c&&225>c?"down":225<=c&&315>=c?"left":"up"}
function createAnimation(c,e){var d=["-up","-left","-down","-right"];if("melee"==e){var f="0"==stab[newindex[c]]?"slash":"stab";animationlist.melee=animationlist[f]}else f=e;for(var g=0;4>g;g++){var m=13*(animationlist[f].start+g);sprite[c].animations.add(e+d[g],arrayFill(m,m+animationlist[f].frames-1),15,!1)}}
function update_ui(c){var e=c.glads.length,d={};for(i=0;i<e;d={$jscomp$loop$prop$j$1:d.$jscomp$loop$prop$j$1},i++){var f=c.glads[i].name,g=c.glads[i].STR,m=c.glads[i].AGI,h=c.glads[i].INT,l=parseInt(c.glads[i].hp),b=parseInt(c.glads[i].maxhp),k=parseInt(c.glads[i].ap),n=parseInt(c.glads[i].maxap),p=parseInt(c.glads[i].lvl),q=parseInt(c.glads[i].xp),r=parseFloat(c.glads[i].buffs.burn.timeleft),t=parseFloat(c.glads[i].buffs.resist.timeleft),u=parseFloat(c.glads[i].buffs.stun.timeleft),v=parseFloat(c.glads[i].buffs.invisible.timeleft),
w=parseFloat(c.glads[i].buffs.movement.timeleft);if(gladArray[i])var x=gladArray[i].poison;""==$(".glad-name span").eq(i).html()&&($(".glad-name span").eq(i).html(f),$(".glad-portrait").eq(i).append(getSpriteThumb(hashes[newindex[i]],"walk","down")));$(".glad-str span").eq(i).html()!==g&&$(".glad-str span").eq(i).html(g);$(".glad-agi span").eq(i).html()!==m&&$(".glad-agi span").eq(i).html(m);$(".glad-int span").eq(i).html()!==h&&$(".glad-int span").eq(i).html(h);$(".lvl-value span").eq(i).html()!=
p&&($(".lvl-value span").eq(i).html(p),$(".lvl-value").eq(i).addClass("up"),d.$jscomp$loop$prop$j$1=i,setTimeout(function(b){return function(){$(".lvl-value").eq(b.$jscomp$loop$prop$j$1).removeClass("up")}}(d),500));$(".xp-bar .filled").eq(i).width()!=q&&$(".xp-bar .filled").eq(i).height(q+"%");$(".hp-bar .filled").eq(i).width()!=l/b*100&&$(".hp-bar .filled").eq(i).width(l/b*100+"%");0>=l?$(".ui-glad").eq(i).addClass("dead"):$(".ui-glad").eq(i).hasClass("dead")&&$(".ui-glad").eq(i).removeClass("dead");
$(".ap-bar .filled").eq(i).width(k/n*100+"%");r?$(".buff-burn").eq(i).addClass("active"):$(".buff-burn").eq(i).hasClass("active")&&$(".buff-burn").eq(i).removeClass("active");t?$(".buff-resist").eq(i).addClass("active"):$(".buff-resist").eq(i).hasClass("active")&&$(".buff-resist").eq(i).removeClass("active");u?$(".buff-stun").eq(i).addClass("active"):$(".buff-stun").eq(i).hasClass("active")&&$(".buff-stun").eq(i).removeClass("active");v?$(".buff-invisible").eq(i).addClass("active"):$(".buff-invisible").eq(i).hasClass("active")&&
$(".buff-invisible").eq(i).removeClass("active");w?$(".buff-speed").eq(i).addClass("active"):$(".buff-speed").eq(i).hasClass("active")&&$(".buff-speed").eq(i).removeClass("active");x?$(".buff-poison").eq(i).addClass("active"):$(".buff-poison").eq(i).hasClass("active")&&$(".buff-poison").eq(i).removeClass("active")}}var showFPS=!1,oldTime=null,avgFPS=0,contFPS=0;
function debugTimer(){if(showFPS){if(oldTime){var c=new Date;avgFPS+=c-oldTime;contFPS++;oldTime=c}else oldTime=new Date;$("#fps").length||($("#canvas-container").append("<div id='fps'></fps>"),c=setInterval(function(){$("#fps").html("FPS: "+parseFloat(1E3/(avgFPS/contFPS)).toFixed(1));contFPS=avgFPS=0},1E3))}else $("#fps").length&&($("#fps").remove(),clearInterval(c))}
$(window).keydown(function(c){c.keyCode==Phaser.Keyboard.F&&(showFPS=(showFPS+1)%2);c.keyCode==Phaser.Keyboard.B&&(showbars=(showbars+1)%2);c.keyCode==Phaser.Keyboard.M&&("flex"==$("#ui-container").css("display")?$("#ui-container").fadeOut():$("#ui-container").fadeIn());c.keyCode==Phaser.Keyboard.SPACEBAR&&$("#pause").click();c.keyCode==Phaser.Keyboard.A&&$("#back-step").click();c.keyCode==Phaser.Keyboard.D&&$("#fowd-step").click();c.keyCode>=Phaser.Keyboard.ONE&&c.keyCode<=Phaser.Keyboard.FIVE&&
(c=c.keyCode-Phaser.Keyboard.ONE,$(".ui-glad").eq(c).click())});function getGladPositionOnCanvas(c){var e=screenH*game.camera.scale.y/31,d=screenW*game.camera.scale.x/29;d=2*d+d*parseFloat(json.glads[c].x);c=5*e+e*parseFloat(json.glads[c].y);e=$("#canvas-div canvas").position().top-game.camera.view.y;var f=$("#canvas-div canvas").position().left;return{x:d+f,y:c+e}}
function showMessageBaloon(c){var e=json.glads[c].message;if(""!=e&&0<json.glads[c].hp){var d=getGladPositionOnCanvas(c);$(".baloon.glad-"+c).length?$(".baloon.glad-"+c).html(e):$("#canvas-div").append("<div class='baloon glad-"+c+"'>"+e+"</div>");c=$(".baloon.glad-"+c);e=d.x+15*game.camera.scale.x;d=d.y-15*game.camera.scale.y-c.outerHeight();c.css({top:d,left:e});200>c.width()&&50<=c.height()?(c.css({left:e-230}),c.addClass("left")):c.hasClass("left")&&c.removeClass("left")}else $(".baloon.glad-"+
c).fadeOut(function(){$(this).remove()})}var showbars=!0;
function showHpApBars(c){gladArray[c].bars&&gladArray[c].bars.clear();if(showbars&&0<json.glads[c].hp){var e=arenaX1+json.glads[c].x*arenaRate,d=arenaY1+json.glads[c].y*arenaRate,f=parseFloat(json.glads[c].hp),g=parseFloat(json.glads[c].maxhp),m=parseFloat(json.glads[c].ap),h=parseFloat(json.glads[c].maxap);gladArray[c].bars.draw(bar.back,e+-15,d+-35,30,9);gladArray[c].bars.draw(bar.hp,e+-15,d+-35,f/g*30,5);gladArray[c].bars.draw(bar.ap,e+-15,d+-30,m/h*30,4)}}
function zoomWheel(c){c=c.deltaY/Math.abs(c.deltaY)*.03;var e=screenW*(game.camera.scale.x-c),d=screenH*(game.camera.scale.y-c);var f=$(window).width()>$(window).height()?e>=$(window).width()?"width":d<=$(window).height()?"height":"none":d>=$(window).height()?"height":e<=$(window).width()?"width":"none";"width"==f?(e=$(window).width(),d=$(window).width()*screenH/screenW,game.camera.scale.x=$(window).width()/screenW,game.camera.scale.y=$(window).width()/screenW):"height"==f?(d=$(window).height(),e=
$(window).height()*screenW/screenH,game.camera.scale.x=$(window).height()/screenH,game.camera.scale.y=$(window).height()/screenH):(game.camera.scale.x-=c,game.camera.scale.y-=c);e>$(window).width()&&(e=$(window).width());d>$(window).height()&&(d=$(window).height());game.scale.setGameSize(e,d);game.camera.bounds.width=screenW;game.camera.bounds.height=screenH;"none"==f&&(e=.03*screenH,game.camera.y=game.input.y<=game.camera.height/3?game.camera.y-e:game.input.y>=2*game.camera.height/3?game.camera.y+
e:0>c?game.camera.y+e/2:game.camera.y-e/2)};
